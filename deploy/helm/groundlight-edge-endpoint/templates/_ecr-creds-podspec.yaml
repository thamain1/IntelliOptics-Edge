{{- define "edge-endpoint.registry-credentials.podSpec" -}}
restartPolicy: Never
serviceAccountName: edge-endpoint-service-account

containers:
  - name: azure-cli
    command:
      - /bin/sh
      - /app/init-azure-access-retrieve.sh
    env:
      - name: INTELLIOPTICS_ENDPOINT
        value: "{{ .Values.upstreamEndpoint }}"
      - name: INTELLIOPTICS_API_TOKEN
        valueFrom:
          secretKeyRef:
            name: IntelliOptics-api-token
            key: INTELLIOPTICS_API_TOKEN
      - name: AZURE_ACR_LOGIN_SERVER
        value: "{{ .Values.acrLoginServer }}"
      - name: AZURE_ACR_USERNAME
        valueFrom:
          secretKeyRef:
            name: azure-acr-bootstrap
            key: AZURE_ACR_USERNAME
      - name: AZURE_ACR_PASSWORD
        valueFrom:
          secretKeyRef:
            name: azure-acr-bootstrap
            key: AZURE_ACR_PASSWORD

    volumeMounts:
      - name: shared-volume
        mountPath: /shared
      - name: init-azure-access
        mountPath: /app/init-azure-access-retrieve.sh
        subPath: init-azure-access-retrieve.sh

  - name: kubectl
    command:
      - /bin/sh
      - /app/init-azure-access-apply.sh
    env:
      - name: AZURE_ACR_LOGIN_SERVER
        value: "{{ .Values.acrLoginServer }}"
      - name: AZURE_ACR_USERNAME
        valueFrom:
          secretKeyRef:
            name: azure-acr-bootstrap
            key: AZURE_ACR_USERNAME
    volumeMounts:
      - name: shared-volume
        mountPath: /shared
      - name: init-azure-access
        mountPath: /app/init-azure-access-apply.sh
        subPath: init-azure-access-apply.sh
volumes:
  - name: init-azure-access
    configMap:
      name: init-azure-access
  - name: shared-volume
    emptyDir: {}
{{- end }}
